---
provider: clab
defaults:
  device: eos
  devices.eos.clab.image: ceos:4.34.2f

plugin: [ebgp.multihop, fabric] # Use EBGP multihop plugin to get loopback EBGP sessions
evpn.session: [] # Do not activate EVPN AF on any BGP session
bgp.multihop.activate.ipv4: [evpn] # ... apart from the multihop sessions

bgp.community.ebgp: [standard, extended] # Propagate extended community over EBGP
bgp.sessions.ipv4: [ebgp] # ... and activate IPv4 AF only on EBGP sessions

bgp.multihop.sessions: # Add loopback-to-loopback EBGP multihop sessions
  - L1-S1
  - L2-S1
  - L3-S1
  # - L1-S2
  # - L2-S2
  # - L3-S2

fabric:
  spines: 1
  spine:
    module: [bgp, evpn]
    bgp:
      as: 65100
      next_hop_self: false

  leafs: 3
  leaf:
    module: [vlan, vxlan, bgp, evpn, vrf, gateway]
    bgp:
      as: "{65000 + count}"
      next_hop_self: false

nodes:
  ext_rtr:
    device: frr
    module: [bgp]
    bgp:
      as: 65999
      originate: "172.16.0.0/12"
  h1:
    device: linux
  h2:
    device: linux
  h3:
    device: linux
  h4:
    device: linux
  h5:
    device: linux

vrfs:
  red:
    evpn.transit_vni: 5042
    # bgp.
    links: [ext_rtr-L3]
  blue:
    evpn.transit_vni: 5043
    # bgp: false
    links: [ext_rtr-L3]

vlans:
  red1:
    vrf: red
    mode: irb
    gateway: True
    vni: 1001
    links: [L1-h1, L2-h2]
  red2:
    vrf: red
    mode: irb
    gateway: True
    vni: 1002
    links: [L2-h3]
  blue1:
    vrf: blue
    mode: irb
    gateway: True
    vni: 2001
    links: [L2-h4]
  blue2:
    vrf: blue
    mode: irb
    gateway: True
    vni: 2002
    links: [L3-h5]

validate:
  ping:
    description: Pinging host from hosts
    nodes: [h1, h3]
    devices: [linux]
    exec: ping -c 10 h5 -A
    valid: |
      "64 bytes" in stdout

  session:
    description: Check the EBGP session on the ISP router
    fail: The EBGP session with your router is not established
    pass: The EBGP session is in the Established state
    nodes: [ext_rtr, L1, L2, L3]
    show:
      frr: bgp summary json
      eos: bgp summary | json

    valid:
      frr: >
        {% for n in bgp.neighbors if n.name == 'L3' %}
        result["ipv4Unicast"]["peers"]["{{ n.ipv4 }}"]["state"] == "Established"{% if not loop.last %} and {% endif %}
        {% endfor %}
      eos: >
        {% for n in bgp.neighbors %}
        result["vrfs"]["default"]["peers"]["{{ n.ipv4 }}"]["peerState"] == "Established"{% if not loop.last %} and {% endif %}
        {% endfor %}

  disable_eth1:
    description: Disable interface on L1
    config:
      template: template
    nodes: [L1]
    pass: int disabled

  session2:
    description: Check EBGP sessions with DUT
    nodes: [L1, L2]
    plugin: bgp_neighbor(node.bgp.neighbors,'S1')
